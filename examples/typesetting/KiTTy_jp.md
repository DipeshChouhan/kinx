# KiTTy

<param style="JBookA4"/>
<param multibytefont="jp"/>
<param titleSize="64.8"/>
<param subtitleSize="14.4"/>
<param subtitle="Small and Easy, but Beautiful Design For You"/>
<param author="Kray-G, Mr.Diamond Global Blue Publisher"/>
<param date="September 18, 2020"/>

## イントロダクション

### KiTTy とは

**KiTTy** は **Ki**nx **T**iny **Ty**pesetting を意味し、
Kinx で実装された簡易組版システムの名称です。
Markdown 形式からの簡易トランスレーターを実装しているため、
Markdown 形式で書かれたドキュメントを美しく組版することができます。
本文書自体も Markdown で記載されているものを自動組版した一つの事例です。

考え方は \\LaTeX に近く、
テキスト形式で管理している文書ファイルを美しく組版することを目的としています。
より具体的には、本システムは \\LaTeX を置き換えることを目的とはしていませんが、
以下を実現することによって、
より個人的な利用シーンの中で、より簡単に利用できるようにすることを目的としています。

*   小さなシステムを維持すること
*   それなりに美しく組版できること
*   直接 PDF ファイルを出力できること

KiTTy は小さなシステムながらある程度美しく組版できる機能を持ち、
Markdown で書かれた文書から直接 PDF ファイルとして出力することができる組版システムです。

#### Versus \\LaTeX

\\LaTeX は巨大なシステムです。
拡張性にも優れ、多くの人々に支えられた美しい文書を作成するための組版システムです。
KiTTy も \\LaTeX と同じ目的を持つ組版システムですが、
限られた機能しか提供しない代わりに小さなシステムとして提供されます。

\\LaTeX の巨大さは、インストールの複雑さにもつながります。
\\TeX、\\LaTeX では様々な機能を提供するためにディストリビューションそのものが複数存在しています。
それにより、ユーザーはまずどのディストリビューションを使うべきかで悩むことになります。
KiTTy は、Kinx パッケージに標準で組み込まれており、
Kinx をインストールすることですぐに使えるようになります。

ただし、小さく、そして簡単に使える代わりにトレードオフとして限られた機能[^1]しか提供されないといった欠点があります。
また、組版スピードはそれほど速くはありません。
パフォーマンスの改善も 1 つの課題です。

[^1]: 「限られた機能」に関しては、「\\nameref{機能概要}」を参照してください。

#### Versus Word

WYSIWYG[^2] のワードプロセッサとして代表的な Word ですが、考え方が異なります。
WYSIWYG では見たままの形式で編集可能ですが、
その見た目情報を一緒に保存するために多くの場合バイナリ形式で保存されます。
そのため、中に何が書かれているか知るには一般的に専用のソフトウェア（この場合 Word）が必要となります。

[^2]: **W**hat **Y**ou **S**ee **I**s **W**hat **Y**ou **G**et の頭文字をとったもの。見たままのものを実際に作成出力するという意味。

KiTTy は \\LaTeX 同様、テキストエディタさえあれば内容を知ることができ、編集することも可能です。

テキストで保存されるということは、別のソフトウェアで処理することも簡単であり、
Git のようなバージョン管理システム上で差分を確認することも容易です。
このことは特に、差分管理をバージョン管理システム上で実現したい場合には必須となる特徴です。

また、文書構造に関しても、
Word では直接的にその見た目から「それが構造化されたもの」か「単に見た目としてそう見えているものか」の区別がつきません。
例えば、章番号がきちんと章番号として設定され、
文章の配置やレイアウトを変更した際に正しく番号を付け直してくれるよう配慮されているかどうかが判別しづらいといった欠点もあります。
特に、どのような書き方をしたとしても「見た目として正しく見えてしまっている」ということにより、
他者の作成したファイルを編集する際に意図せず正しく設定してくれていなかった、といった不運もたびたび見られます。

KiTTy では、文書構造をテキストで表現する関係上、
章やセクション、図、表などのリファレンスを常に正しく把握し、
適切な番号付け、および相互参照機能を実現することができます。

その代わり、WYSIWYG のようにその場で出力後の体裁（見た目）を確認することができない、
といった欠点があります。

#### 結論

要約すると、以下のケースにおいて KiTTy は有益でしょう。

*   \\TeX のような巨大なシステムではなく、小さな組版システムで簡単に利用したい
*   Git のようなバージョン管理システムを使った差分管理をしたい
*   文書構造を常に適切に把握し、相互参照などを正確に実施したい
*   サポートされている機能で十分、また多少の遅さは許容範囲である

ちょっとした文書作成のために \\TeX をフルセットで使うには巨大すぎる、と感じている方で、
テキストで文書管理をしたい、と考えている方[^3]のために本システムを用意しました。
特に、Git で差分を含めた文書管理を行いたい場合、
WYSIWYG で実現されているワープロソフトでの管理は大変困難ですので、
主にそういった利用シーンを想定しています。

[^3]: つまり、私のような方。

<pagebreak/>

### サポート機能

KiTTy は、以下の機能をサポートしています。

*   基本機能
    *   ハイフネーション・ジャスティフィケーション・行分割
    *   ウィドウ／オーファン
    *   箇条書き
    *   数式
    *   イメージ
    *   グラフ（チャート）
    *   テーブル
    *   色
    *   プログラム・コード
    *   相互参照
    *   外部リンク
    *   脚注
    *   合字
*   日本語用処理
    *   日本語禁則処理
    *   日本語ルビ

基本機能に加え、日本語特有の処理が組み込まれています。
日本語以外の言語への拡張は私自身に知見が乏しいためシステムのソースコードに影響する可能性がありますが、
ソースコードは公開されているので必要に応じて拡張することは可能と考えています。
ただし、言語ごとの固有の拡張ポイントを意識していないので、
大幅な修正、もしくは機能追加が必要かもしれません。

## さあ始めよう

### インストール

インストールは以下の 2 ステップを実施します。

1. Kinx のインストール
2. KiTTy 追加モジュールのインストール

### ビルド

通常、ビルドから実施する必要はありません。
既にインストーラが提供されており、手順に従ってインストールを実施することで本システムを利用することができます。
あえてビルドから実行したい、といった場合は以下の手順によってビルドを実施できます。

### hello, world

次の文書を作成し、`helloworld.md` ファイルとして保存します。

```markdown:lineNumber=false
hello, world
```

## 機能概要

### 基本機能

#### ハイフネーション・ジャスティフィケーション・行分割

![float=right,scale=0.5,caption=ハイフネーション・両端揃え,label=image1](linebreak.png)

Franklin M. Liang のアルゴリズムに基づくハイフネーションをサポートしています。
また、ハイフネーションに伴うジャスティフィケーション（両端揃え）機能をサポートしています。

行分割は Knuth-Plass Line Breaking アルゴリズムを採用しています。
本アルゴリズムは、Box、Glue、Penalty によって分割位置をコントロールするアルゴリズムであり、
\\TeX で実装されているアルゴリズムと同様です。
これらハイフネーション・アルゴリズムも行分割アルゴリズムも、
今のところ組版システムでは最良の方法として知られている方法です。
ただし、実装自体は Kinx で改めて行われているため、
必ずしも出力結果は \\TeX での出力と同一にはならない場合があります。

#### ウィドウ／オーファン

ウィドウ、およびオーファンに対するペナルティ処理を一部ですが実施します。
全てのケースで有効ではありませんのでご注意ください。
具体的には以下のケースで有効です。

*   セクション名がページの最後に取り残されるケースを抑止。
    *   この場合、セクション名ごと次のページに追い出されます。
*   複数行パラグラフにおいて、最後の行のみ次のページに送られるケースを抑止。
    *   この場合、最後の 2 行分が次のページに追い出されます。
*   複数行パラグラフにおいて、最初の行のみ前のページに残るケースを抑止。
    *   この場合、全ての行が次のページに追い出されます。
    *   この処理の結果としてセクションが残る場合、セクション自体も次のページに追い出されます。

これらの処理は自動的に行われます。
特に文書内に指示を記載する必要はありません。
ただし、全てのケースで正しく動作をする訳ではありませんので、
うまくレイアウトされない場合は必要に応じて `<pagebreak/>` コマンドを使って改ページを行ってください。

<pagebreak/>

#### 箇条書き

箇条書きは記号によるものと番号付きのものが利用できます。
次の例は記号による箇条書きの例です。

```
*   レベル1
    *   レベル2
        *   レベル3
            *   レベル4
```

これは以下のように整形されます。

*   レベル1
    *   レベル2
        *   レベル3
            *   レベル4

次の例は番号付き箇条書きの例です。
数値ラベルは自動的に補正されます。

```
1.  レベル1
    1.  レベル2
        1.  レベル3
            1.  レベル4
            1.  レベル4
```

これは以下のように整形されます。

1.  レベル1
    1.  レベル2
        1.  レベル3
            1.  レベル4
            1.  レベル4

また、両者を混在させることも可能です。
次の例は混在させた場合の箇条書きの例です。

```
*   レベル1
    1.  レベル2
        *   レベル3
            1.  レベル4
```

これは以下のように整形されます。

*   レベル1
    1.  レベル2
        *   レベル3
            1.  レベル4

#### 数式

KiTTy は \\KaTeX を内蔵しており、数式を表現することも可能です。
数式はスタンドアロン形式とインライン形式の 2 つの表現方法があります。

##### スタンドアロン形式

スタンドアロン形式はコードブロックの形式で記載し、1 行で表現されます。
その際、言語として `math` を指定します。

    ```math:label=Math1
    \begin{aligned}
        \int_{-\infty}^{\infty} f(x) dx &= \sqrt{\pi}
    \end{aligned}
    ```

上記のように記載すると、以下のように表現されます。
`label` オプションは付けなくても問題ありませんが、
ラベルを付けておくことで \\ref{Math1} のように数式への参照を行うことが可能です。

```math:label=Math1
\begin{aligned}
    \int_{-\infty}^{\infty} f(x) dx &= \sqrt{\pi}
\end{aligned}
```

ただし、\\KaTeX はラベル機能を持っていないため、ラベル機能は KiTTy によって実現されています。
したがって、2 つの式を表現する場合にはラベルを自分自身でコントロールする必要があります。

    ```math:label=Math2(0.2)/Math3(0.6)
    \begin{aligned}
        E &= mc^2 \\
        m &= \frac{m_0}{\sqrt{1-\frac{v^2}{c^2}}} \\
    \end{aligned}
    ```

上記のようにすることで、ラベルの配置位置を数式の上端からそれぞれ 20%、60% の位置に Math2、Math3 のラベルを配置します。

```math:label=Math2(0.2)/Math3(0.6)
\begin{aligned}
    E &= mc^2 \\
    m &= \frac{m_0}{\sqrt{1-\frac{v^2}{c^2}}} \\
\end{aligned}
```

これによって、`\ref{Math2}` と記載することで \\ref{Math2} への参照を、
`\ref{Math3}` と記載することで \\ref{Math3} への参照を作成することが可能となります。

##### インライン形式

インラインで数式を扱う場合は `$` で囲みます。
例えば、`$E = mc^2$` と記載すると、$E = mc^2$ と表現されます。
また、インテグラルなどの高さのある表記をインラインで記載すると、
例えば \\ref{Math1} と同じ `$\\int\_{-\\infty}^{\\infty} f(x) dx = \\sqrt{\\pi}$` を記載すると、
$\\int\_{-\\infty}^{\\infty} f(x) dx = \\sqrt{\\pi}$ と表現されます。
尚、`$` で括った中では　Markdown の記法と重なるため、
`\` や `_` を `\` でエスケープする必要があることにご注意ください。

仮に大きな形式で表現したい場合は `\\displaystyle` を先頭につけて記載します。
例えば、`$\\displaystyle\\int\_{-\\infty}^{\\infty} f(x) dx = \\sqrt{\\pi}$` と `\\displaystyle` を付けて記載すると、
$\\displaystyle\\int\_{-\\infty}^{\\infty} f(x) dx = \\sqrt{\\pi}$ と表現されます。
ただし、行の高さが揃わないためあまりお勧めするものではありません。

#### イメージ

イメージは Markdown のイメージ形式で記載しますが、
`alt` 部分にオプションを指定し、`![options](path)` の形で記載します。
スタンドアロン形式での挿入、インラインでの図の挿入、およびテキストを周りに配置する形でのフローティング形式で挿入することが可能です。

##### スタンドアロン・イメージ

全幅で表示させるには前後を空行の形にし、独立したパラグラフで記載します。

```:lineNumber=false
![scale=0.6](kinxlogo.png)
```

上記のように記載すると以下のように図が挿入されます。
`scale=0.6` の指定により版面の横幅の 60% の大きさに補正されて表示されます。
また、縦横の比率は維持されます。

![scale=0.6](kinxlogo.png)

##### インライン・イメージ

インラインの例です。
インラインで図を挿入する場合、
文中に直接以下のように書きます。

```:lineNumber=false
ファイルアイコンは ![scale=0.08,offsetY=-0.8](zip256.png) になります。
```

この場合、「ファイルアイコンは ![scale=0.08,offsetY=-0.8](zip256.png) になります。」と表現されます。
図の元のサイズに応じて `scale` と `offsetY` を適宜調整してください。

##### フローティング・イメージ

イメージをフローティングさせるには、オプションに `float=left` または `float=right` を指定します。
p.\\pageref{image1} に示している
\\nameref{image1} はフローティング・イメージの一例です。

![float=left,caption=イトトンボ,scale=0.5](damselfly.jpg)

左の図は Public Domain で配布されている図[^4]です。
このような形でイメージをフローティングさせることができます。
フローティング形式でも版面の横幅に対するスケールとして `scale` の指定が可能ですが、
版面の横幅の最大 70% までに補正（制限）されます[^5]。

[^4]: https://free-images.com/
[^5]: この 70% にはイメージとテキストの間の余白を含みます。

また、このようにフローティングされている間に段落を分けることも可能です。
同じようにテキスト処理され、
最終的にフローティングされたイメージの下までパラグラフの文章が到達した場合、
自動的にテキスト幅が版面の幅に戻り、
自然な形でテキストが配置されます。

![float=right,caption=F14 Tomcats](f14_tomcats.jpg)

また、右のイメージのようにパラグラフの右側に配置することも可能です。
イメージは上記と同様 Public Domain のものを使わせていただいています。

1 つ注意点としては、
パラグラフの先頭とイメージの上端の位置を合わせる必要があることです。
パラグラフの途中にフローティングさせることはできません。
あるパラグラフを開始する際にフローティングすべきイメージがあれば、
パラグラフの左右どちらか指定した場所にイメージを配置します。

##### オプション

オプションは以下のものを使用できます。

| オプション | 値  | 意味 |
| ---------- | --- | ---- |
| `scale`    |     |      |

#### グラフ（チャート）

グラフ（チャート）も挿入可能です。
グラフもスタンドアロン形式とフローティング形式の両形式をサポートしています。

##### スタンドアロン・グラフ

##### フローティング・グラフ

#### テーブル

#### 色

#### プログラム・コード

#### 相互参照

#### 外部リンク

#### 脚注

#### 合字

### 日本語用機能

#### 日本語禁則処理

#### 日本語ルビ

## コマンド

### パラグラフ処理コマンド

### スタンドアロン・コマンド

## 機能拡張

### スタイル

### 禁則処理

